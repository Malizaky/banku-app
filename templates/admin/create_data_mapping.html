{% extends "base.html" %}

{% block title %}Create Data Mapping - Admin{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-plus me-2"></i>Create Data Storage Mapping</h2>
                <a href="{{ url_for('admin.dynamic_data_mappings') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Back to Mappings
                </a>
            </div>

            <div class="row">
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Mapping Configuration</h5>
                        </div>
                        <div class="card-body">
                            <form id="createMappingForm">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="item_type_id" class="form-label">Item Type <span class="text-danger">*</span></label>
                                            <select class="form-select" id="item_type_id" name="item_type_id" required>
                                                <option value="">Select item type</option>
                                                {% for item_type in item_types %}
                                                <option value="{{ item_type.id }}">{{ item_type.display_name }} ({{ item_type.name }})</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="chatbot_id" class="form-label">Chatbot <span class="text-danger">*</span></label>
                                            <select class="form-select" id="chatbot_id" name="chatbot_id" required>
                                                <option value="">Select chatbot</option>
                                                {% for chatbot in chatbots %}
                                                <option value="{{ chatbot.id }}">{{ chatbot.name }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="bank_id" class="form-label">Storage Bank <span class="text-danger">*</span></label>
                                            <select class="form-select" id="bank_id" name="bank_id" required>
                                                <option value="">Select bank</option>
                                                {% for bank in banks %}
                                                <option value="{{ bank.id }}">{{ bank.name }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <hr class="my-4">
                                <h6 class="text-muted mb-3">Data Mapping Configuration</h6>

                                <div class="mb-3">
                                    <label for="data_mapping" class="form-label">Field Mapping (JSON)</label>
                                    <textarea class="form-control" id="data_mapping" name="data_mapping" rows="8" placeholder='{
  "chatbot_field": "item_field",
  "question_1": "title",
  "question_2": "description",
  "question_3": "category"
}'></textarea>
                                    <div class="form-text">Map chatbot question IDs to item fields (JSON format)</div>
                                </div>

                                <div class="mb-3">
                                    <label for="validation_rules" class="form-label">Validation Rules (JSON)</label>
                                    <textarea class="form-control" id="validation_rules" name="validation_rules" rows="6" placeholder='{
  "title": {"required": true, "min_length": 5},
  "description": {"required": true, "min_length": 10},
  "category": {"required": true, "allowed_values": ["products", "services"]}
}'></textarea>
                                    <div class="form-text">Define validation rules for each field (JSON format)</div>
                                </div>

                                <div class="mb-3">
                                    <label for="storage_config" class="form-label">Storage Configuration (JSON)</label>
                                    <textarea class="form-control" id="storage_config" name="storage_config" rows="4" placeholder='{
  "auto_save": true,
  "backup_enabled": true,
  "notify_on_save": false
}'></textarea>
                                    <div class="form-text">Additional storage settings (JSON format)</div>
                                </div>

                                <div class="d-flex justify-content-end gap-2">
                                    <a href="{{ url_for('admin.dynamic_data_mappings') }}" class="btn btn-secondary">Cancel</a>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save me-2"></i>Create Mapping
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Preview</h5>
                        </div>
                        <div class="card-body">
                            <div id="mappingPreview">
                                <div class="border rounded p-3 mb-3">
                                    <h6 class="mb-2">Data Flow</h6>
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div class="text-center">
                                            <div class="badge bg-success mb-1" id="previewChatbot">Chatbot</div>
                                            <div class="small text-muted">Collects Data</div>
                                        </div>
                                        <div class="text-center">
                                            <i class="fas fa-arrow-right text-muted"></i>
                                        </div>
                                        <div class="text-center">
                                            <div class="badge bg-warning mb-1" id="previewBank">Bank</div>
                                            <div class="small text-muted">Stores Data</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="border rounded p-3">
                                    <h6 class="mb-2">Item Type</h6>
                                    <div class="small">
                                        <div class="mb-1">
                                            <strong>Type:</strong> <span id="previewItemType" class="text-muted">Not selected</span>
                                        </div>
                                        <div class="mb-1">
                                            <strong>Fields:</strong> <span id="previewFields" class="text-muted">0 mapped</span>
                                        </div>
                                        <div class="mb-1">
                                            <strong>Rules:</strong> <span id="previewRules" class="text-muted">0 defined</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-3">
                        <div class="card-header">
                            <h5 class="card-title mb-0">JSON Examples</h5>
                        </div>
                        <div class="card-body">
                            <h6>Data Mapping:</h6>
                            <pre class="small bg-light p-2 rounded"><code>{
  "question_1": "title",
  "question_2": "description",
  "question_3": "category"
}</code></pre>
                            
                            <h6 class="mt-3">Validation Rules:</h6>
                            <pre class="small bg-light p-2 rounded"><code>{
  "title": {
    "required": true,
    "min_length": 5
  },
  "description": {
    "required": true,
    "min_length": 10
  }
}</code></pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('createMappingForm');
    const previewChatbot = document.getElementById('previewChatbot');
    const previewBank = document.getElementById('previewBank');
    const previewItemType = document.getElementById('previewItemType');
    const previewFields = document.getElementById('previewFields');
    const previewRules = document.getElementById('previewRules');

    // Update preview when inputs change
    function updatePreview() {
        const itemTypeId = document.getElementById('item_type_id').value;
        const chatbotId = document.getElementById('chatbot_id').value;
        const bankId = document.getElementById('bank_id').value;
        const dataMapping = document.getElementById('data_mapping').value;
        const validationRules = document.getElementById('validation_rules').value;

        // Update chatbot
        const chatbotSelect = document.getElementById('chatbot_id');
        const selectedChatbot = chatbotSelect.options[chatbotSelect.selectedIndex];
        previewChatbot.textContent = chatbotId ? selectedChatbot.text : 'Chatbot';

        // Update bank
        const bankSelect = document.getElementById('bank_id');
        const selectedBank = bankSelect.options[bankSelect.selectedIndex];
        previewBank.textContent = bankId ? selectedBank.text : 'Bank';

        // Update item type
        const itemTypeSelect = document.getElementById('item_type_id');
        const selectedItemType = itemTypeSelect.options[itemTypeSelect.selectedIndex];
        previewItemType.textContent = itemTypeId ? selectedItemType.text : 'Not selected';

        // Count fields and rules
        let fieldCount = 0;
        let ruleCount = 0;

        try {
            if (dataMapping) {
                const mapping = JSON.parse(dataMapping);
                fieldCount = Object.keys(mapping).length;
            }
        } catch (e) {
            // Invalid JSON
        }

        try {
            if (validationRules) {
                const rules = JSON.parse(validationRules);
                ruleCount = Object.keys(rules).length;
            }
        } catch (e) {
            // Invalid JSON
        }

        previewFields.textContent = `${fieldCount} mapped`;
        previewRules.textContent = `${ruleCount} defined`;
    }

    // Add event listeners
    document.getElementById('item_type_id').addEventListener('change', updatePreview);
    document.getElementById('chatbot_id').addEventListener('change', updatePreview);
    document.getElementById('bank_id').addEventListener('change', updatePreview);
    document.getElementById('data_mapping').addEventListener('input', updatePreview);
    document.getElementById('validation_rules').addEventListener('input', updatePreview);

    // Handle form submission
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        
        // Parse JSON fields
        try {
            if (data.data_mapping) {
                data.data_mapping = JSON.parse(data.data_mapping);
            } else {
                data.data_mapping = {};
            }
        } catch (e) {
            alert('Invalid JSON in data mapping field');
            return;
        }

        try {
            if (data.validation_rules) {
                data.validation_rules = JSON.parse(data.validation_rules);
            } else {
                data.validation_rules = {};
            }
        } catch (e) {
            alert('Invalid JSON in validation rules field');
            return;
        }

        try {
            if (data.storage_config) {
                data.storage_config = JSON.parse(data.storage_config);
            } else {
                data.storage_config = {};
            }
        } catch (e) {
            alert('Invalid JSON in storage config field');
            return;
        }
        
        fetch('{{ url_for("admin.create_data_mapping") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = '{{ url_for("admin.dynamic_data_mappings") }}';
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while creating the mapping.');
        });
    });

    // Initialize preview
    updatePreview();
});
</script>
{% endblock %}
